<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="icon" href="../../img/fy2000_tb.png">
<title>TV 小知识</title>
<style type="text/css">
#ys01 {
	text-align: center;
	font-weight: bold;
}
.ys02 {
	text-align: center;
}
.ys01 {
	font-family: "微软雅黑";
	text-align: center;
	font-size: 18px;
}
a:link {
	text-decoration: none;
}
a:visited {
	text-decoration: none;
}
a:hover {
	text-decoration: underline;
}
a:active {
	text-decoration: none;
	color: #E4E4E4;
}
.ys022 {font-size: 14px;
	color: #000;
}
.ys011 {
	font-family: "黑体";
	font-size: 36px;
	color: #F00;
}
.ys03 {font-family: "宋体";
	font-size: 24px;
	color: #000;
}
.ys05 {	font-size: 9px;
	font-family: "黑体";
}
.ys05 {
	font-size: 20px;
	color: #000;
	font-family: "微软雅黑";
}
.ys021 {
	font-family: "微软雅黑";
	font-size: 24px;
	color: #000;
}
.ysh12 {font-family: "黑体";
	font-size: 36px;
	color: #F00;
}
.ysh03 {	font-family: "幼圆";
	font-size: 18px;
	color: #F60;
}
.ysh03 {	font-weight: bold;
	color: #030;
	font-size: 24px;
}
.ysh10 {	font-family: "隶书";
	font-size: 18px;
	color: #999;
}
.ys0211 {
	font-size: 14px;
	color: #06C;
}
.ys0111 {	font-size: 18px;
	color: #06C;
}
.ysh05 {
	font-family: "黑体";
	font-size: 36px;
	color: #E8DBE6;
}
</style>
<script type="text/javascript">
function MM_preloadImages() { //v3.0
  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();
    var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)
    if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}
}
</script>
</head>

<body>
<p class="ys02"><img src="../img/item_top.gif" width="1000" height="53" alt="item_top" /></p>
<hr width="1000" />
<table width="1000" border="0" align="center" cellpadding="10">
  <tr>
    <td colspan="2" align="right" bgcolor="#C1C1FF"><span class="ys022">[<a href="#bottom">跳到末尾</a>][<a href="../TV_index.html">返回主页</a>]</span></td>
  </tr>
  <tr>
    <td colspan="2" align="center" bgcolor="#C1C1FF" class="ysh1"><a name="top" id="top"></a><span class="ys011">TV平台按键板学习</span></td>
  </tr>
  <tr>
    <td width="132" align="center" bgcolor="#99FFFF"><a href="tv_item/TV_sys.html" class="ys01">知识模块</a></td>
    <td width="822" valign="middle" bgcolor="#E8E8D7">（以下内容都是基于Mstar NonOS软件架构而言）</td>
  </tr>
  <tr align="center">
    <td align="center" valign="top" bgcolor="#69B6DA"><p><a href="TV_sys.html" class="ys01">TV系统</a><br />
      <a href="Vital_func.html" class="ys01">重要函数体<br />
      </a><a href="State_machine.html" class="ys01">状态机</a><br />
      <a href="Timer.html" class="ys01">软定时器</a><br />
      <a href="IR.html" class="ys01">红外遥控<br />
    </a><a href="Keypad.html" class="ys01">按键板<br />
    </a><a href="tv_item/Skintool.html" class="ys01"></a><a href="Skintool.html" class="ys01">Skintool<br />
    </a><a href="other.html" class="ys01">其它</a></p></td>
    <td width="822" align="left" valign="top" bgcolor="#E8E8D7"><p class="ys03">概要：</p>
      <ol>
        <li><span class="ys05"><a href="#keypadfunction">按键板的作用</a></span></li>
        <li><span class="ys05"><a href="#hwsx">Mstar-Nonos-Code中按键板的实现</a></span></li>
        <li><span class="ys05"><a href="#swsx">Mstar-Nonos-Code中按键板的软件实现</a></span></li>
        <li><span class="ys05"><a href="#keyget">配置按键板时，码值如何获得</a></span></li>
    </ol>      <p class="ysh22">&nbsp;</p></td>
  </tr>
  <tr align="center">
    <td rowspan="6" valign="top" bgcolor="#69B6DA">&nbsp;</td>
    <td width="822" align="left" valign="top" bgcolor="#E8E8D7"><p><span class="ys021">一、<a name="keypadfunction" id="keypadfunction"></a>按键板的作用（即为什么要用按键板？）</span></p>
      <p><span class="ys012"><span class="ys04"><span class="ys023"><span class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TV首先是作为一个传送活动的图像画面和音频信号的设备，其次也是重要的广播和视屏通讯工具。</span></span></span></span><span class="ys023"><span class="ys05">既然是设备，在与人的交互过程中就需要一些输入控制动作，这些简单的输入功能的应用就产生了按键板，通俗的说，按键板就是人与TV交互的工具，因此在早期的TV平台上按键板是必不可少的，后来随着技术的发展，红外遥控的出现，按键板在实际的生活中退居二线，作为辅助角色存在。</span></span></p></td>
  </tr>
  <tr align="center">
    <td align="left" valign="top" bgcolor="#E8E8D7"><p class="ys021">二、<a name="hwsx" id="hwsx"></a>Mstar-Nonos-Code中按键板的实现</p>
    <p class="ys021"><span class="ys05">1.原理图</span></p>
    <p class="ys021"><img src="../img/单路ADC.gif" alt="单路ADC" width="750" height="315" hspace="30" /></p>
    <p class="ys021"><img src="../img/双路ADC.gif" alt="双路ADC" width="750" height="340" hspace="30" /></p>
    <p class="ys05">&nbsp;&nbsp;&nbsp; 2.采样方式和上层处理</p>
    <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a.由上图可以看出，按键板中的按键是以不同的电压作为判别的标准来区分按键的。通过使用电阻分压的方式来实现。</p>
    <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b.IC采到对应按键的电压后，会通过A\D转换器将电压量化为用于IC处理的数字信号。然后存储在对应的寄存器中，用于上层处理使用。</p>
    <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c.接着上层应用程序读取存储在寄存器中的电压数值，由于寄存器中存储的为二进制，因此在使用时需要进行转化（转化过程封装的Code已经实现，不用我们实现）。然后将读取的数字与我们预先设定的理论值进行对比，满足波动范围的即为有效按键值，不满足的视为无效值，若为有效值，上层就会选择对应的功能执行，若无效，软件会抛弃这个值，不做处理。</p></td>
  </tr>
  <tr align="center">
    <td align="left" valign="top" bgcolor="#E8E8D7"><p class="ys021">三、<a name="swsx" id="swsx"></a>Mstar-Nonos-Code中按键板的软件实现</p>
    <p class="ys021"><span class="ys05">1.由于<span class="ys04">ADC采样，A\D转化，</span>电压值存储等都是硬件自动完成的，因此在这里不做介绍。</span></p>
    <p class="ys021"><span class="ys05">2.主要讲解上层读取寄存器到执行功能的处理过程：</span></p>
    <p class="ys021">&nbsp;&nbsp; &nbsp; &nbsp;<span class="ys05">a.文件 MApp_MultiTasks.c 文件中的 MApp_MultiTasks（） 函数会一直在跑，这个函数中首先会用函数 MApp_ProcessUserInput()检验用户的输入，即按键板也是在这里侦测的。在用户输入函数中用 MApp_CheckKeyStatus()判断用户是否有按键按下，如果有按键按下，即 msAPI_GetKeyPad(&amp;key, &amp;KeyRepeatStatus)返回 MSRET_OK，那么在参数key中会取得按键的码值，然后将key中的值赋专门用来存储按键值的变量------stKeyStatus.keydata，直接被上层使用；否则不做任何处理，等待下一次输入。</span></p>
    <p class="ys021"><span class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b.那么 msAPI_GetKeyPad(&amp;key, &amp;KeyRepeatStatus)是如何获取key的呢？首先在这个函数体内可以看到已经有一个专门的封装函数msKeypad_GetKey(u8key, u8Repstatus)，跳入定义的地方发现，是一个for循环在检测所有的ADC采样通道，循环中函数------msKeypad_CH_GetKey(Channel, pkey, pflag)用来检测所有的通道，并获取码值。函数msKeypad_CH_GetKey(Channel, pkey, pflag)是整个按键板学习的关键，里面涉及了很多对按键处理的知识点，确保了获取的码值是正确的。</span></p>
    <p class="ys021">&nbsp;&nbsp; &nbsp; &nbsp;<span class="ys05">c.接下来剖析函数msKeypad_CH_GetKey()</span></p>
    <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 首先函数的一开始都是初始化，这里说两个，一个是存储按键的key值：*pkey = 0xFF;</p>
    <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 然后是存储8个按键状态值的数组KEY_LV[i]，用for循环初始化：</p>
    <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(i=0; i&lt;ADC_KEY_LEVEL; i++)<br />
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KEY_LV[i] = 0;</p>
    <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 接着，函数 msKeypad_GetChanIndex(Channel)用来确定当前检测的ADC线路是否为可用的线路，返回对应ID ，如果可用，软件会将一组我们给定的理论值数组和与值对应的功能flag 数组分别赋值给指针 KeyLevelmap和Keymapping用于后续的码值检验。</p>
    <p class="ys05"><span class="ys023">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 然后为取码最关键的部分，即要确定码值的有效范围，接下来为两个f嵌套的or循环用来确保取到的值为正确的按键值，作用如下：</span></p>
    <p class="ys05"><span class="ys023"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for（i=0;i&lt;6;i++）&nbsp; &nbsp;用来连续取6次值，确保按键稳定<br />
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for（i=0;i&lt;8;i++）&nbsp;每次取值都要查询8个按键状态，确保不漏取<br />
   &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="ys023">{<br />
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //码值范围锁定，然后按键状态加一，表示一次取值成功<br />
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
    <p class="ys05"><span class="ys023">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在上面第二个for循环中一般情况下为锁定范围为理论值上下波动0.13V即可，但是由于在实际的执行当中很有一些劣质的按键板跳出理论范围，因此，此处经过改进采用无缝连接做法。以下为形象说明：</span></p>
    <p class="ys05"><img src="../img/例图16.gif" alt="例图16" width="454" height="340" hspace="30" /></p>
    <p class="ys05">	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 从上图可以看出无缝连接的有效范围即取两个数中间的值为边界，这样的话，按键无论有无波动，都会落在一个区间内，从而避免无法采样导致的按键无作用的问题。接下来就是用一个for循环通过判断成功的次数，确定哪个按键按下了，然后通过时间计数判定是否为repeat 按键。这样按键值就被取出来了，紧接着通过和Keymapping指向的功能数组比对，获取相应的功能键值供上层调用。</p></td>
  </tr>
  <tr align="center">
    <td align="left" valign="top" bgcolor="#E8E8D7"><p class="ysh72"><span class="ys021">四、<a name="keyget" id="keyget"></a>配置按键板时，码值如何获得</span></p>
      <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.第一种方法：</p>
      <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 首先要确定自己的板子型号，根据型号在source  insight中的用户文件中找对应的按键板，记下。</p>
      <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 确认使用的按键板通道。</p>
      <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在keypad.c文件中查看函数</p>
      <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U8 GetUSB_UpdateDetect(void)和<br />
       &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msKeypad_Get_ADC_Channel(U8  Channel, U8 *pvalue) </p>
      <p class="ys05">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过第二个函数可以找到对应的按键寄存器通过debug工具找到对应的寄存器，按键取值。然后在对应的主板文件中找到对应的按键板程序，按通道修改即可。 </p>
<p class="ys05">温馨提示：第一通道是后面变，第二通道是前面变。每个通道都是从上到下由小到大。</p>
<p class="ys05">&nbsp;&nbsp;	&nbsp;&nbsp;&nbsp;	2.第二种方法：</p>
<p class="ys05">&nbsp;&nbsp;	&nbsp;&nbsp;	&nbsp;直接看板卡原理图，按标注的理论值填写。</p></td>
  </tr>
  <tr align="center">
    <td align="left" valign="top" bgcolor="#E8E8D7"><span class="ysh12"><a name="bottom" id="bottom"></a>感谢阅读</span></td>
  </tr>
  <tr align="center">
    <td width="822" align="right" valign="top" bgcolor="#E8E8D7"><span class="ys0211"><span class="ys022">[<a href="../TV_index.html">返回主页</a>]</span>[<a href="#top">返回顶部</a>]</span></td>
  </tr>
  <tr>
    <td colspan="2" align="center" bgcolor="#FF9999"><span class="ys02"><span class="ysh03">※※※※※※※※※※※※※※※【札 记 分 享】</span><span class="ysh03">※</span><span class="ysh03">※</span><span class="ysh03">※</span><span class="ysh03">※</span><span class="ysh03">※</span><span class="ysh03">※</span><span class="ysh03">※</span><span class="ysh03">※</span><span class="ysh03">※※※</span><span class="ysh03">※</span><span class="ysh03">※</span><span class="ysh03">※※</span></span></td>
  </tr>
  <tr>
    <td height="100" colspan="2" align="center" background="../img/背景2.jpg" class="ysh05">梦想还是要有的，万一实现了呢</td>
  </tr>
</table>
<hr align="center" width="1000" />
<table width="1000" border="0" align="center">
  <tr>
    <td class="ysh10">本想沉溺于莲花深处，不料翻滚于水物之间</td>
  </tr>
  <tr>
    <td><span class="ys0211">更新日期 
  &nbsp;&nbsp;
  &nbsp;
  <!-- #BeginDate format:fCh2m -->2018年2月8日 星期四   12:06<!-- #EndDate -->
    </span></td>
  </tr>
  <tr>
    <td><span class="ys0111">欢迎访问官网 www.fy2000.org 蓝天的精灵工作室</span></td>
  </tr>
</table>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p class="ys02">&nbsp;</p>
</body>
</html>
